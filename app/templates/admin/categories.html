{% extends "admin/base.html" %}

{% block title %}Manage Categories - Admin{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Categories List -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-6">Categories</h2>
            
            <div class="space-y-4">
                {% for category in categories %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-900">{{ category.name }}</h3>
                            <p class="text-sm text-gray-500 mt-1">{{ category.description }}</p>
                            <p class="text-xs text-gray-400 mt-2">
                                <i class="fas fa-file-text mr-1"></i>
                                {{ category_counts.get(category.id, 0) }} prompts
                            </p>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.description }}')" 
                                    class="text-blue-600 hover:text-blue-900 text-sm">
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Add New Category Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-6">Add New Category</h2>
            
            <form method="POST" action="/secure-admin-2024/api/categories" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Category Name</label>
                    <input type="text" 
                           name="name" 
                           id="name" 
                           required
                           placeholder="e.g., Research, Solutions, etc."
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea name="description" 
                              id="description" 
                              rows="3"
                              placeholder="Brief description of this category..."
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <button type="submit" 
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>Add Category
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Category</h3>
        
        <form id="editForm" class="space-y-4">
            <input type="hidden" id="editCategoryId">
            
            <div>
                <label for="editName" class="block text-sm font-medium text-gray-700">Category Name</label>
                <input type="text" 
                       id="editName" 
                       required
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="editDescription" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="editDescription" 
                          rows="3"
                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" 
                        onclick="closeEditModal()"
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                    Cancel
                </button>
                <button type="submit" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Update Category
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function editCategory(id, name, description) {
    document.getElementById('editCategoryId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editDescription').value = description;
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModal').classList.add('flex');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
}

document.getElementById('editForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const id = document.getElementById('editCategoryId').value;
    const name = document.getElementById('editName').value;
    const description = document.getElementById('editDescription').value;
    
    try {
        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        
        const response = await fetch(`/secure-admin-2024/api/categories/${id}`, {
            method: 'PATCH',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating category');
        }
    } catch (error) {
        alert('Error updating category');
    }
});
</script>
{% endblock %}