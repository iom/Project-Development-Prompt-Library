{% extends "admin/base.html" %}

{% block title %}
    {% if prompt %}Edit Prompt{% else %}Add New Prompt{% endif %} - Admin
{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-medium text-gray-900">
                {% if prompt %}Edit Prompt{% else %}Add New Prompt{% endif %}
            </h2>
            <a href="/secure-admin-2024/prompts" 
               class="text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left mr-2"></i>Back to Prompts
            </a>
        </div>

        <form method="POST" class="space-y-6">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                <input type="text" 
                       name="title" 
                       id="title" 
                       required
                       value="{{ prompt.title if prompt else '' }}"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="category_id" class="block text-sm font-medium text-gray-700">Category</label>
                <select name="category_id" 
                        id="category_id" 
                        required
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select a category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" 
                            {% if prompt and prompt.category_id == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">AI Platforms</label>
                <div class="space-y-2">
                    {% set platforms = ['ChatGPT', 'Claude', 'Copilot', 'Copilot (Researcher)', 'Perplexity', 'Gemini', 'Other'] %}
                    {% set selected_platforms = prompt.get_platforms() if prompt else [] %}
                    
                    {% for platform in platforms %}
                    <div class="flex items-center">
                        <input type="checkbox" 
                               name="platform_choice" 
                               value="{{ platform }}"
                               {% if platform in selected_platforms %}checked{% endif %}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                               id="platform_{{ loop.index }}">
                        <label for="platform_{{ loop.index }}" class="ml-2 text-sm text-gray-900">{{ platform }}</label>
                    </div>
                    {% endfor %}
                </div>
                <p class="mt-2 text-sm text-gray-500">Select all platforms where this prompt works effectively</p>
                <input type="hidden" id="ai_platforms_json" name="ai_platforms" value="">
            </div>

            <div>
                <label for="instructions" class="block text-sm font-medium text-gray-700">Usage Instructions</label>
                <textarea name="instructions" 
                          id="instructions" 
                          rows="4"
                          placeholder="Provide clear instructions for how to use this prompt effectively..."
                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">{{ prompt.instructions if prompt else '' }}</textarea>
                <p class="mt-2 text-sm text-gray-500">Describe how to use this prompt, any prerequisites, document uploads needed, etc.</p>
            </div>

            <div>
                <label for="body" class="block text-sm font-medium text-gray-700">Prompt Content</label>
                <textarea name="body" 
                          id="body" 
                          rows="12" 
                          required
                          placeholder="Enter the full prompt text here..."
                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">{{ prompt.body if prompt else '' }}</textarea>
            </div>

            <div>
                <label for="tags" class="block text-sm font-medium text-gray-700">Tags</label>
                <input type="text" 
                       name="tags" 
                       id="tags" 
                       value="{{ prompt.tags if prompt else '' }}"
                       placeholder="Enter tags separated by commas"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <p class="mt-2 text-sm text-gray-500">Separate multiple tags with commas</p>
            </div>

            <div>
                <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                <select name="status" 
                        id="status" 
                        required
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="published" {% if not prompt or prompt.status == 'published' %}selected{% endif %}>Published</option>
                    <option value="draft" {% if prompt and prompt.status == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="archived" {% if prompt and prompt.status == 'archived' %}selected{% endif %}>Archived</option>
                </select>
            </div>

            {% if prompt %}
            <!-- Document Management Section (only for existing prompts) -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">
                    <i class="fas fa-paperclip mr-2"></i>Document Attachments
                </h3>
                
                <!-- Existing Documents -->
                <div id="documents-list" class="space-y-3 mb-4">
                    {% if documents %}
                        {% for doc in documents %}
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md" id="document-{{ doc.id }}">
                            <div class="flex items-center space-x-3">
                                {% if doc.document_type == 'file' %}
                                    <i class="fas fa-file text-blue-600"></i>
                                    <span class="text-sm font-medium">{{ doc.title }}</span>
                                    <span class="text-xs text-gray-500">({{ doc.mime_type }})</span>
                                {% else %}
                                    <i class="fas fa-external-link-alt text-green-600"></i>
                                    <a href="{{ doc.external_url }}" target="_blank" 
                                       class="text-sm font-medium text-blue-600 hover:underline">{{ doc.title }}</a>
                                {% endif %}
                            </div>
                            <button type="button" 
                                    onclick="deleteDocument({{ doc.id }})"
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 text-sm">No documents attached yet.</p>
                    {% endif %}
                </div>

                <!-- Add New Document -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <div class="flex space-x-2 mb-4">
                        <button type="button" 
                                onclick="showFileUpload()"
                                class="bg-blue-600 text-white px-3 py-2 text-sm rounded-md hover:bg-blue-700">
                            <i class="fas fa-upload mr-2"></i>Upload File
                        </button>
                        <button type="button" 
                                onclick="showLinkForm()"
                                class="bg-green-600 text-white px-3 py-2 text-sm rounded-md hover:bg-green-700">
                            <i class="fas fa-link mr-2"></i>Add Link
                        </button>
                    </div>

                    <!-- File Upload Form -->
                    <div id="file-upload-form" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Document Title</label>
                            <input type="text" 
                                   id="file-title" 
                                   placeholder="Enter a descriptive title for this document"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Choose File</label>
                            <input type="file" 
                                   id="file-input" 
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif"
                                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" 
                                    onclick="uploadFile()"
                                    class="bg-blue-600 text-white px-3 py-2 text-sm rounded-md hover:bg-blue-700">
                                Upload
                            </button>
                            <button type="button" 
                                    onclick="hideFileUpload()"
                                    class="bg-gray-300 text-gray-700 px-3 py-2 text-sm rounded-md hover:bg-gray-400">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- External Link Form -->
                    <div id="link-form" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Link Title</label>
                            <input type="text" 
                                   id="link-title" 
                                   placeholder="Enter a descriptive title for this link"
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">URL</label>
                            <input type="url" 
                                   id="link-url" 
                                   placeholder="https://..."
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" 
                                    onclick="addLink()"
                                    class="bg-green-600 text-white px-3 py-2 text-sm rounded-md hover:bg-green-700">
                                Add Link
                            </button>
                            <button type="button" 
                                    onclick="hideLinkForm()"
                                    class="bg-gray-300 text-gray-700 px-3 py-2 text-sm rounded-md hover:bg-gray-400">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="flex justify-end space-x-3">
                <a href="/secure-admin-2024/prompts" 
                   class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                    Cancel
                </a>
                <button type="submit" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    {% if prompt %}Update Prompt{% else %}Create Prompt{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Handle form submission to convert checkboxes to JSON
document.querySelector('form').addEventListener('submit', function(e) {
    const checkboxes = document.querySelectorAll('input[name="platform_choice"]:checked');
    const selectedPlatforms = Array.from(checkboxes).map(cb => cb.value);
    const jsonValue = JSON.stringify(selectedPlatforms);
    
    console.log('JS DEBUG - Form submission:');
    console.log('  checkboxes found:', checkboxes.length);
    console.log('  selected platforms:', selectedPlatforms);
    console.log('  JSON value:', jsonValue);
    
    document.getElementById('ai_platforms_json').value = jsonValue;
    
    console.log('  hidden field value after set:', document.getElementById('ai_platforms_json').value);
    console.log('  hidden field name:', document.getElementById('ai_platforms_json').name);
});

// Also populate on page load for edit forms
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        // Always populate the hidden field with current state (even if empty)
        const checkboxes = document.querySelectorAll('input[name="platform_choice"]:checked');
        const selectedPlatforms = Array.from(checkboxes).map(cb => cb.value);
        document.getElementById('ai_platforms_json').value = JSON.stringify(selectedPlatforms);
    }
});

// Document Management Functions
function showFileUpload() {
    document.getElementById('file-upload-form').classList.remove('hidden');
    document.getElementById('link-form').classList.add('hidden');
}

function hideFileUpload() {
    document.getElementById('file-upload-form').classList.add('hidden');
    document.getElementById('file-title').value = '';
    document.getElementById('file-input').value = '';
}

function showLinkForm() {
    document.getElementById('link-form').classList.remove('hidden');
    document.getElementById('file-upload-form').classList.add('hidden');
}

function hideLinkForm() {
    document.getElementById('link-form').classList.add('hidden');
    document.getElementById('link-title').value = '';
    document.getElementById('link-url').value = '';
}

async function uploadFile() {
    const fileInput = document.getElementById('file-input');
    const titleInput = document.getElementById('file-title');
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload.');
        return;
    }
    
    if (!titleInput.value.trim()) {
        alert('Please enter a title for the document.');
        return;
    }
    
    const file = fileInput.files[0];
    const title = titleInput.value.trim();
    const promptId = {{ prompt.id if prompt else 'null' }};
    
    try {
        // First, get a presigned upload URL
        const formData = new FormData();
        formData.append('filename', file.name);
        formData.append('content_type', file.type);
        formData.append('size', file.size.toString());
        
        const uploadResponse = await fetch('/secure-admin-2024/api/documents/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!uploadResponse.ok) {
            const errorData = await uploadResponse.text();
            let errorMessage = 'Failed to get upload URL';
            try {
                const errorJson = JSON.parse(errorData);
                errorMessage = errorJson.detail || errorMessage;
            } catch (e) {
                errorMessage = errorData || errorMessage;
            }
            throw new Error(errorMessage);
        }
        
        const uploadData = await uploadResponse.json();
        
        // Upload the file to the presigned URL
        const fileUploadResponse = await fetch(uploadData.upload_url, {
            method: 'PUT',
            body: file,
            headers: {
                'Content-Type': file.type
            }
        });
        
        if (!fileUploadResponse.ok) {
            throw new Error('Failed to upload file');
        }
        
        // Save document metadata
        const metadataFormData = new FormData();
        metadataFormData.append('prompt_id', promptId);
        metadataFormData.append('title', title);
        metadataFormData.append('document_type', 'file');
        metadataFormData.append('file_path', uploadData.file_path);
        metadataFormData.append('file_size', file.size.toString());
        metadataFormData.append('mime_type', file.type);
        
        const metadataResponse = await fetch('/secure-admin-2024/api/documents', {
            method: 'POST',
            body: metadataFormData
        });
        
        if (!metadataResponse.ok) {
            throw new Error('Failed to save document metadata');
        }
        
        const documentData = await metadataResponse.json();
        
        // Add the new document to the list
        addDocumentToList(documentData);
        hideFileUpload();
        
    } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload file: ' + error.message);
    }
}

async function addLink() {
    const titleInput = document.getElementById('link-title');
    const urlInput = document.getElementById('link-url');
    
    if (!titleInput.value.trim()) {
        alert('Please enter a title for the link.');
        return;
    }
    
    if (!urlInput.value.trim()) {
        alert('Please enter a URL.');
        return;
    }
    
    const title = titleInput.value.trim();
    const url = urlInput.value.trim();
    const promptId = {{ prompt.id if prompt else 'null' }};
    
    try {
        const formData = new FormData();
        formData.append('prompt_id', promptId);
        formData.append('title', title);
        formData.append('document_type', 'link');
        formData.append('external_url', url);
        
        const response = await fetch('/secure-admin-2024/api/documents', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            let errorMessage = 'Failed to add link';
            try {
                const errorJson = JSON.parse(errorData);
                errorMessage = errorJson.detail || errorMessage;
            } catch (e) {
                // If not JSON, use the raw text
                errorMessage = errorData || errorMessage;
            }
            throw new Error(errorMessage);
        }
        
        const documentData = await response.json();
        
        // Add the new document to the list
        addDocumentToList(documentData);
        hideLinkForm();
        
    } catch (error) {
        console.error('Add link error:', error);
        alert('Failed to add link: ' + error.message);
    }
}

function addDocumentToList(doc) {
    const list = document.getElementById('documents-list');
    
    // Remove "no documents" message if it exists
    const noDocsMsg = list.querySelector('.text-gray-500');
    if (noDocsMsg) {
        noDocsMsg.remove();
    }
    
    const docElement = document.createElement('div');
    docElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
    docElement.id = `document-${doc.id}`;
    
    if (doc.document_type === 'file') {
        docElement.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="fas fa-file text-blue-600"></i>
                <span class="text-sm font-medium">${doc.title}</span>
                <span class="text-xs text-gray-500">(${doc.mime_type || 'file'})</span>
            </div>
            <button type="button" 
                    onclick="deleteDocument(${doc.id})"
                    class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        `;
    } else {
        docElement.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="fas fa-external-link-alt text-green-600"></i>
                <a href="${doc.external_url}" target="_blank" 
                   class="text-sm font-medium text-blue-600 hover:underline">${doc.title}</a>
            </div>
            <button type="button" 
                    onclick="deleteDocument(${doc.id})"
                    class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }
    
    list.appendChild(docElement);
}

async function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) {
        return;
    }
    
    try {
        const response = await fetch(`/secure-admin-2024/api/documents/${docId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete document');
        }
        
        // Remove the document from the list
        const docElement = document.getElementById(`document-${docId}`);
        if (docElement) {
            docElement.remove();
        }
        
        // If no documents left, show "no documents" message
        const list = document.getElementById('documents-list');
        if (list.children.length === 0) {
            list.innerHTML = '<p class="text-gray-500 text-sm">No documents attached yet.</p>';
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete document: ' + error.message);
    }
}
</script>
{% endblock %}